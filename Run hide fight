local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- 创建主界面
local gunTrackerGUI = Instance.new("ScreenGui")
gunTrackerGUI.Name = "GunTrackerGUI"
gunTrackerGUI.ResetOnSpawn = false

-- 创建主框架
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 200, 0, 300)
mainFrame.Position = UDim2.new(0, 10, 0, 10)
mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
mainFrame.BorderSizePixel = 0
mainFrame.ClipsDescendants = true

-- 标题栏
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 30)
titleBar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
titleBar.Parent = mainFrame

local titleText = Instance.new("TextLabel")
titleText.Size = UDim2.new(0.7, 0, 1, 0)
titleText.Text = "Player with gun"
titleText.TextColor3 = Color3.fromRGB(255, 255, 255)
titleText.BackgroundTransparency = 1
titleText.Font = Enum.Font.GothamBold
titleText.TextSize = 14
titleText.Parent = titleBar

-- 折叠/展开按钮
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0.2, 0, 0.8, 0)  -- 宽度20%，高度80%
toggleButton.Position = UDim2.new(0.8, 0, 0.1, 0)  -- 从80%位置开始，向下偏移10%
toggleButton.Text = "-"
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
toggleButton.BorderSizePixel = 0
toggleButton.Parent = titleBar

-- 玩家列表容器
local listFrame = Instance.new("ScrollingFrame")
listFrame.Size = UDim2.new(1, 0, 1, -30)
listFrame.Position = UDim2.new(0, 0, 0, 30)
listFrame.BackgroundTransparency = 1
listFrame.ScrollingDirection = Enum.ScrollingDirection.Y
listFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
listFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
listFrame.ScrollBarThickness = 4
listFrame.Parent = mainFrame

-- 列表布局
local listLayout = Instance.new("UIListLayout")
listLayout.Padding = UDim.new(0, 2)
listLayout.Parent = listFrame

listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    listFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y)
end)

mainFrame.Parent = gunTrackerGUI
gunTrackerGUI.Parent = playerGui

-- 持枪玩家检测系统
local gunPlayers = {}
local isExpanded = true

-- 折叠/展开功能
local function toggleGUI()
    isExpanded = not isExpanded
    if isExpanded then
        mainFrame.Size = UDim2.new(0, 200, 0, 300)
        toggleButton.Text = "-"
        listFrame.Visible = true
    else
        mainFrame.Size = UDim2.new(0, 200, 0, 30)
        toggleButton.Text = "+"
        listFrame.Visible = false
    end
end

toggleButton.MouseButton1Click:Connect(toggleGUI)

-- 检查玩家是否有枪
local function hasGun(player)
    local backpack = player:FindFirstChild("Backpack")
    if not backpack then return false end
    
    local gunTypes = {"AK47", "M4", "UZI", "Pistol", "Shotgun"}
    
    for _, gunName in pairs(gunTypes) do
        local gun = backpack:FindFirstChild(gunName)
        if gun and gun:FindFirstChild("GunScript") then
            return true, gunName
        end
    end
    
    return false
end

-- 更新玩家列表显示
local function updatePlayerList()
    -- 清空现有列表
    for _, child in pairs(listFrame:GetChildren()) do
        if child:IsA("Frame") then
            child:Destroy()
        end
    end
    
    -- 添加持枪玩家到列表
    for playerName, gunName in pairs(gunPlayers) do
        local playerFrame = Instance.new("Frame")
        playerFrame.Size = UDim2.new(1, -10, 0, 25)
        playerFrame.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        playerFrame.BorderSizePixel = 0
        
        local playerText = Instance.new("TextLabel")
        playerText.Size = UDim2.new(1, -5, 1, 0)
        playerText.Position = UDim2.new(0, 5, 0, 0)
        playerText.Text = playerName .. " (" .. gunName .. ")"
        playerText.TextColor3 = Color3.fromRGB(255, 255, 255)
        playerText.BackgroundTransparency = 1
        playerText.Font = Enum.Font.Gotham
        playerText.TextSize = 12
        playerText.TextXAlignment = Enum.TextXAlignment.Left
        playerText.Parent = playerFrame
        
        playerFrame.Parent = listFrame
    end
    
    -- 如果没有持枪玩家
    if next(gunPlayers) == nil then
        local emptyFrame = Instance.new("Frame")
        emptyFrame.Size = UDim2.new(1, -10, 0, 25)
        emptyFrame.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        emptyFrame.BorderSizePixel = 0
        
        local emptyText = Instance.new("TextLabel")
        emptyText.Size = UDim2.new(1, -5, 1, 0)
        emptyText.Position = UDim2.new(0, 5, 0, 0)
        emptyText.Text = "No player with gun"
        emptyText.TextColor3 = Color3.fromRGB(150, 150, 150)
        emptyText.BackgroundTransparency = 1
        emptyText.Font = Enum.Font.Gotham
        emptyText.TextSize = 12
        emptyText.TextXAlignment = Enum.TextXAlignment.Left
        emptyText.Parent = emptyFrame
        
        emptyFrame.Parent = listFrame
    end
end

-- 检查特定玩家
local function checkPlayer(player)
    local hasWeapon, gunType = hasGun(player)
    if hasWeapon then
        gunPlayers[player.Name] = gunType
    else
        gunPlayers[player.Name] = nil
    end
    updatePlayerList()
end

-- 检查所有玩家
local function checkAllPlayers()
    gunPlayers = {}
    
    for _, player in pairs(Players:GetPlayers()) do
        local hasWeapon, gunType = hasGun(player)
        if hasWeapon then
            gunPlayers[player.Name] = gunType
        end
    end
    
    updatePlayerList()
end

-- 玩家加入游戏
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        wait(1)
        checkPlayer(player)
    end)
end)

-- 玩家离开游戏
Players.PlayerRemoving:Connect(function(player)
    gunPlayers[player.Name] = nil
    updatePlayerList()
end)

-- 监听现有玩家的角色变化
for _, player in pairs(Players:GetPlayers()) do
    if player ~= Players.LocalPlayer then
        player.CharacterAdded:Connect(function()
            wait(1)
            checkPlayer(player)
        end)
    end
end

-- 初始检查
checkAllPlayers()

-- 定期检查（防止遗漏）
while true do
    wait(1)
    checkAllPlayers()
end
